{
	"name": "StandardizePrevalenceDF",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ADLS_DiabetesPrevalence_JSON",
						"type": "DatasetReference"
					},
					"name": "STGDiabetesPrevalence"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ADLS_STDDiabetesPrevalence_Parquet",
						"type": "DatasetReference"
					},
					"name": "SinkToStandardized"
				}
			],
			"transformations": [
				{
					"name": "FlattenValue"
				},
				{
					"name": "SelectRelevantColumns"
				},
				{
					"name": "FilterScandinavia"
				},
				{
					"name": "RemapGenderAndAge"
				},
				{
					"name": "SortValues"
				}
			],
			"scriptLines": [
				"source(output(",
				"          {@odata.context} as string,",
				"          value as (Comments as string, DataSourceDim as string, DataSourceDimType as string, Date as string, Dim1 as string, Dim1Type as string, Dim2 as string, Dim2Type as string, Dim3 as string, Dim3Type as string, High as double, Id as integer, IndicatorCode as string, Low as double, NumericValue as double, ParentLocation as string, ParentLocationCode as string, SpatialDim as string, SpatialDimType as string, TimeDim as short, TimeDimType as string, TimeDimensionBegin as string, TimeDimensionEnd as string, TimeDimensionValue as short, Value as string)[]",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     documentForm: 'documentPerLine') ~> STGDiabetesPrevalence",
				"STGDiabetesPrevalence foldDown(unroll(value, value),",
				"     mapColumn(",
				"          value",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> FlattenValue",
				"FilterScandinavia select(mapColumn(",
				"          year = value.TimeDim,",
				"          country = value.SpatialDim,",
				"          sex = value.Dim1,",
				"          age = value.Dim2,",
				"          {diabetes%} = value.NumericValue,",
				"          lower_confidence = value.Low,",
				"          upper_confidence = value.High",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> SelectRelevantColumns",
				"FlattenValue filter((value.SpatialDim == 'DNK' && value.Dim1 != 'SEX_BTSX') ||",
				"(value.SpatialDim == 'SWE' && value.Dim1 != 'SEX_BTSX') ||",
				"(value.SpatialDim == 'NOR' && value.Dim1 != 'SEX_BTSX')) ~> FilterScandinavia",
				"SelectRelevantColumns derive(sex = iif(sex == 'SEX_MLE', 'M',\r",
				"  iif(sex == 'SEX_FMLE', 'F', sex)),",
				"          age = iif(age == 'AGEGROUP_YEARS18-PLUS', '18Above', \r",
				"    iif(age == 'AGEGROUP_YEARS30-PLUS', '30Above', age))) ~> RemapGenderAndAge",
				"RemapGenderAndAge sort(asc(year, true),",
				"     asc(country, true),",
				"     asc(sex, true)) ~> SortValues",
				"SortValues sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'parquet',",
				"     truncate: true,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> SinkToStandardized"
			]
		}
	}
}